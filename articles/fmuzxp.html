<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Android 服务 - KingPunch Studio</title>
    
    <link rel="stylesheet" href="../R0PdhoKCFEmBy40MbC295rXtUg1GlsRhjQqboZ6sZPk.css">
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/default.min.css">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.4.0/highlight.min.js"></script>
    <style>
        .table {
            width: 100%;
            margin-bottom: 10px;
            border-collapse: collapse;
            font-size: 12px;
            border-spacing: 0;
            line-height: 18px;
            max-width: 100%;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            outline: 0;
            margin-top: 20px;
        }

        .table td:first-child {
            width: 72px;
        }

        .table td {
            padding: 8px;
            border: 1px solid #dadada;
            text-align: left;
            margin: 0;
            vertical-align: baseline;
        }
    </style>
</head>

<body>
    <div class="topbar-renderer">
        <c3-overlay hidden>
            <button class="hidden-button" aria-label="关闭搜索功能"></button>
        </c3-overlay>
        <header class="topbar-header">
            <button class="topbar-back-arrow" hidden>
                <c3-icon class="undefined" flip-for-rtl="true">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24"
                        height="24" width="24">
                        <path d="M21,11v1H5.64l6.72,6.72l-0.71,0.71L3.72,11.5l7.92-7.92l0.71,0.71L5.64,11H21z"></path>
                    </svg>
                </c3-icon>
            </button>
            <button class="topbar-header-endpoint">
                <c3-icon class="topbar-logo">
                    <svg id="icon-link" viewBox="0 0 24 24">
                        <path
                            d="M9.199 13.599c0.992 1.327 2.43 2.126 3.948 2.345s3.123-0.142 4.45-1.134c0.239-0.179 0.465-0.375 0.655-0.568l2.995-2.995c1.163-1.204 1.722-2.751 1.696-4.285s-0.639-3.061-1.831-4.211c-1.172-1.132-2.688-1.692-4.199-1.683-1.492 0.008-2.984 0.571-4.137 1.683l-1.731 1.721c-0.392 0.389-0.394 1.023-0.004 1.414s1.023 0.394 1.414 0.004l1.709-1.699c0.77-0.742 1.763-1.117 2.76-1.123 1.009-0.006 2.016 0.367 2.798 1.122 0.795 0.768 1.203 1.783 1.221 2.808s-0.355 2.054-1.11 2.836l-3.005 3.005c-0.114 0.116-0.263 0.247-0.428 0.37-0.885 0.662-1.952 0.902-2.967 0.756s-1.971-0.678-2.632-1.563c-0.331-0.442-0.957-0.533-1.4-0.202s-0.533 0.957-0.202 1.4zM14.801 10.401c-0.992-1.327-2.43-2.126-3.948-2.345s-3.124 0.142-4.451 1.134c-0.239 0.179-0.464 0.375-0.655 0.568l-2.995 2.995c-1.163 1.204-1.722 2.751-1.696 4.285s0.639 3.061 1.831 4.211c1.172 1.132 2.688 1.692 4.199 1.683 1.492-0.008 2.984-0.571 4.137-1.683l1.723-1.723c0.391-0.391 0.391-1.024 0-1.414s-1.024-0.391-1.414 0l-1.696 1.698c-0.77 0.742-1.763 1.117-2.76 1.123-1.009 0.006-2.016-0.367-2.798-1.122-0.795-0.768-1.203-1.783-1.221-2.808s0.355-2.054 1.11-2.836l3.005-3.005c0.114-0.116 0.263-0.247 0.428-0.37 0.885-0.662 1.952-0.902 2.967-0.756s1.971 0.678 2.632 1.563c0.331 0.442 0.957 0.533 1.4 0.202s0.533-0.957 0.202-1.4z">
                        </path>
                    </svg>
                </c3-icon>
            </button>
            <div class="searchbox" hidden>
                <form class="searchbox-form">
                    <div class="searchbox-input-wrapper">
                        <input type="text" class="searchbox-input" autocomplete="off" autocorrect="off"
                            spellcheck="false" placeholder="在 KingPunch Studio 中搜索">
                    </div>
                    <input type="submit" hidden>
                    <button class="icon-button " aria-haspopup="false">
                        <c3-icon>
                            <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24"
                                viewBox="0 0 24 24" width="24">
                                <path
                                    d="M20.87,20.17l-5.59-5.59C16.35,13.35,17,11.75,17,10c0-3.87-3.13-7-7-7s-7,3.13-7,7s3.13,7,7,7c1.75,0,3.35-0.65,4.58-1.71 l5.59,5.59L20.87,20.17z M10,16c-3.31,0-6-2.69-6-6s2.69-6,6-6s6,2.69,6,6S13.31,16,10,16z">
                                </path>
                            </svg>
                        </c3-icon>
                    </button>
                </form>
                <div class="searchbox-dropdown" hidden>
                    <div class="sbdd_a">
                        <ul class="sbsb_b">
                            <li class="sbsb_c">
                                <div class="sbpqs_d">
                                    <span class="sbpqs_a">
                                        视频编辑
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="topbar-header-content">
                <h1 class="topbar-title">
                    首页
                </h1>
                <button class="icon-button">
                    <c3-icon>
                        <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24"
                            viewBox="0 0 24 24" width="24">
                            <path
                                d="M20.87,20.17l-5.59-5.59C16.35,13.35,17,11.75,17,10c0-3.87-3.13-7-7-7s-7,3.13-7,7s3.13,7,7,7c1.75,0,3.35-0.65,4.58-1.71 l5.59,5.59L20.87,20.17z M10,16c-3.31,0-6-2.69-6-6s2.69-6,6-6s6,2.69,6,6S13.31,16,10,16z">
                            </path>
                        </svg>
                    </c3-icon>
                </button>
                <button class="icon-button">
                    <c3-icon>
                        <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24"
                            viewBox="0 0 24 24" width="24">
                            <path
                                d="M12,16.5c0.83,0,1.5,0.67,1.5,1.5s-0.67,1.5-1.5,1.5s-1.5-0.67-1.5-1.5S11.17,16.5,12,16.5z M10.5,12 c0,0.83,0.67,1.5,1.5,1.5s1.5-0.67,1.5-1.5s-0.67-1.5-1.5-1.5S10.5,11.17,10.5,12z M10.5,6c0,0.83,0.67,1.5,1.5,1.5 s1.5-0.67,1.5-1.5S12.83,4.5,12,4.5S10.5,5.17,10.5,6z">
                            </path>
                        </svg>
                    </c3-icon>
                </button>
            </div>
        </header>
    </div>
    <div style="height: 48px;"></div>
    <div class="container">
        <div class="main">
            
            <div class="article">

                <div class="markdown">
                    <div class="article-meta">
                        <ul class="breadcrumb-list">
                            <li class="breadcrumb-item">
                                <a href="/">首页</a>
                            </li>
                            <li class="breadcrumb-item">
                                <div class="breadcrumb-guillemet">
                                    <svg id="icon-navigate_next" viewBox="0 0 24 24">
                                        <path d="M9.984 6l6 6-6 6-1.406-1.406 4.594-4.594-4.594-4.594z"></path>
                                    </svg>
                                </div>
                                <a href="/topics/android">Android</a>
                            </li>

                        </ul>
                    </div>
                    <h1>Android 服务</h1>

                    <img style="width: 100%;margin: 32px 0" alt="Android 服务"
                        src="//static.lucidu.cn/images/20220107-vltniz.png">

                    <p><code>Service</code> 是一种可在后台长时间执行操作的无界面应用组件。</p>
<p>分三种类型：</p>
<ul>
<li>前台</li>
<li>后台</li>
<li>绑定</li>
</ul>
<p>通过清单文件可将服务声明为私有服务，阻止其他应用访问该服务。<a href="https://developer.android.com/guide/components/services#Declaring">使用清单文件声明服务</a>部分将对此做更详尽的阐述。</p>
<div class="caution">
<p><strong>注意 ：</strong> 服务在主线程中运行。如果服务将执行任何 CPU 密集型工作或阻止性操作（例如 MP3 播放或联网），则应通过在服务内创建新线程来完成这项工作。通过使用单独的线程，可以降低发生“应用无响应”(ANR) 错误的风险。</p>
</div>
<h2 id="section">基础知识</h2>
<ul>
<li><p><code>onStartCommand()</code></p>
<p>当请求启动服务时，系统会通过调用 <code>startService()</code> 来调用此方法。执行此方法时，服务即会启动并可在后台无限期运行。如果实现此方法，在服务工作完成后，需通过调用 <code>stopSelf()</code> 或 <code>stopService()</code> 来停止服务。（如果只是提供绑定，则无需实现此方法。）</p>
</li>
<li><p><code>onBind()</code></p>
<p>当与服务绑定时，系统会通过调用 <code>bindService()</code> 来调用此方法。在此方法的实现中，必须通过返回 <code>IBinder</code> 提供一个接口，以供客户端用来与服务进行通信。如果不允许绑定，则应返回 <code>null</code>。</p>
</li>
<li><p><code>onCreate()</code></p>
<p>服务首次创建时，系统会（在调用 <code>onStartCommand()</code> 或 <code>onBind()</code> 之前）调用此方法来执行一次性设置程序。如果服务已在运行，则不会调用此方法。</p>
</li>
<li><p><code>onDestroy()</code></p>
<p>当服务将销毁时，系统会调用此方法。服务应通过实现此方法来清理任何资源，如线程、注册的侦听器、接收器等。这是服务接收的最后一个调用。</p>
</li>
</ul>
<p>如果通过调用 <code>bindService()</code> 来创建服务，且未调用 <code>onStartCommand()</code>，则服务只会在绑定时运行。当取消所有绑定后，系统便会将其销毁。</p>
<p>只有在内存过低且必须回收系统资源以供拥有用户焦点的 <code>Activity</code> 使用时，Android 系统才会停止服务。如果将服务绑定到拥有用户焦点的 <code>Activity</code>，则它其不太可能会终止；如果将服务声明为在前台运行，则其几乎永远不会终止。如果服务已启动并长时间运行，则系统逐渐降低其在后台任务列表中的位置，而服务被终止的概率也会大幅提升—如果服务是启动服务，则必须将其设计为能够妥善处理系统执行的重启。如果系统终止服务，则其会在资源可用时立即重启服务，但这还取决于从 <code>onStartCommand()</code> 返回的值。</p>
<h3 id="section-1">使用清单文件声明服务</h3>
<p>如同对 Activity 及其他组件的操作一样，必须在应用的清单文件中声明所有服务。</p>
<p>如要声明服务，请在 <a href="https://developer.android.com/guide/topics/manifest/application-element"><code>&lt;application&gt;</code></a> 元素中添加 <code>&lt;service&gt;</code> 子元素。下面是示例：</p>
<pre><code class="language-xml">&lt;manifest ... &gt;
  ...
  &lt;application ... &gt;
      &lt;service android:name=&quot;.ExampleService&quot; /&gt;
      ...
  &lt;/application&gt;
&lt;/manifest&gt;
</code></pre>
<h2 id="section-2">创建启动服务</h2>
<p>例如，假设某 Activity 需要将一些数据保存到在线数据库中。该 Activity 可以启动一个协同服务，并通过向 <code>startService()</code> 传递一个 Intent，为该服务提供要保存的数据。服务会通过 <code>onStartCommand()</code> 接收 Intent，连接到互联网并执行数据库事务。事务完成后，服务将自行停止并销毁。</p>
<pre><code class="language-java">public class HelloService extends Service {
  private Looper serviceLooper;
  private ServiceHandler serviceHandler;

  // Handler that receives messages from the thread
  private final class ServiceHandler extends Handler {
      public ServiceHandler(Looper looper) {
          super(looper);
      }
      @Override
      public void handleMessage(Message msg) {
          // Normally we would do some work here, like download a file.
          // For our sample, we just sleep for 5 seconds.
          try {
              Thread.sleep(5000);
          } catch (InterruptedException e) {
              // Restore interrupt status.
              Thread.currentThread().interrupt();
          }
          // Stop the service using the startId, so that we don't stop
          // the service in the middle of handling another job
          stopSelf(msg.arg1);
      }
  }

  @Override
  public void onCreate() {
    // Start up the thread running the service. Note that we create a
    // separate thread because the service normally runs in the process's
    // main thread, which we don't want to block. We also make it
    // background priority so CPU-intensive work doesn't disrupt our UI.
    HandlerThread thread = new HandlerThread(&quot;ServiceStartArguments&quot;,
            Process.THREAD_PRIORITY_BACKGROUND);
    thread.start();

    // Get the HandlerThread's Looper and use it for our Handler
    serviceLooper = thread.getLooper();
    serviceHandler = new ServiceHandler(serviceLooper);
  }

  @Override
  public int onStartCommand(Intent intent, int flags, int startId) {
      Toast.makeText(this, &quot;service starting&quot;, Toast.LENGTH_SHORT).show();

      // For each start request, send a message to start a job and deliver the
      // start ID so we know which request we're stopping when we finish the job
      Message msg = serviceHandler.obtainMessage();
      msg.arg1 = startId;
      serviceHandler.sendMessage(msg);

      // If we get killed, after returning from here, restart
      return START_STICKY;
  }

  @Override
  public IBinder onBind(Intent intent) {
      // We don't provide binding, so return null
      return null;
  }

  @Override
  public void onDestroy() {
    Toast.makeText(this, &quot;service done&quot;, Toast.LENGTH_SHORT).show();
  }
}
</code></pre>
<p>请注意，<code>onStartCommand()</code> 方法必须返回整型数。整型数是一个值，用于描述系统应如何在系统终止服务的情况下继续运行服务。从 onStartCommand() 返回的值必须是以下常量之一：</p>
<ul>
<li><p><code>START_NOT_STICKY</code></p>
<p>如果系统在 <code>onStartCommand()</code> 返回后终止服务，则除非有待传递的挂起 Intent，否则系统不会重建服务。</p>
</li>
<li><p><code>START_STICKY</code></p>
<p>如果系统在 <code>onStartCommand()</code> 返回后终止服务，则其会重建服务并调用 <code>onStartCommand()</code>，但不会重新传递最后一个 Intent。相反，除非有挂起 Intent 要启动服务，否则系统会调用包含空 Intent 的 onStartCommand()。</p>
</li>
<li><p><code>START_REDELIVER_INTENT</code></p>
<p>如果系统在 <code>onStartCommand()</code> 返回后终止服务，则其会重建服务，并通过传递给服务的最后一个 Intent 调用 <code>onStartCommand()</code>。所有挂起 Intent 均依次传递。</p>
</li>
<li><p><a href="https://developer.android.com/guide/components/services">https://developer.android.com/guide/components/services</a></p>
</li>
<li><p><a href="https://developer.android.com/guide/topics/manifest/service-element">https://developer.android.com/guide/topics/manifest/service-element</a></p>
</li>
</ul>


                    

                </div>
            </div>
        </div>
        <aside></aside>

    </div>
    <div class="menu-container" hidden>
        <div class="menu-content">
            <ytm-menu-item>
                <a class="menu-item-button">登录</a>
            </ytm-menu-item>
        </div>
        <c3-overlay>
            <button class="hidden-button" aria-label="close"></button>
        </c3-overlay>
    </div>
    <custom-toast id="toast"></custom-toast>
    <script src="../r_tamzTkQ7EA-wJxwAXIN8C1Qll9lCJkdsaKZOxlWvc.js"></script>
    <script>
        function writeText(message) {
            const textarea = document.createElement("textarea");
            textarea.style.position = 'fixed';
            textarea.style.right = '100%';
            document.body.appendChild(textarea);
            textarea.value = message;
            textarea.select();
            document.execCommand('copy');
            textarea.remove();
        }

        function bindAllCodeElements() {
            const toast = document.getElementById('toast');
            document.querySelectorAll('code')
                .forEach(x => {
                    x.addEventListener('click', ev => {
                        writeText(ev.target.textContent);
                        toast.setAttribute('message', '已成功复制到剪切板。');
                    });
                });

        }

        function lazyLoadImages() {
            const observer = new IntersectionObserver(function (entries) {
                Array.prototype.forEach.call(entries, function (entry) {
                    if (entry.isIntersecting) {
                        observer.unobserve(entry.target);
                        entry.target.src = entry.target.getAttribute("data-src");
                    }
                });
            });
            Array.prototype.forEach.call(document.querySelectorAll('img'), function (image) {
                if (image.hasAttribute('data-src'))
                    observer.observe(image);
            });
        }

        bindAllCodeElements();
        lazyLoadImages();
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el);
            });
        });
    </script>
</body>

</html>